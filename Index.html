<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>NAMS Restroom Sign-Out</title>
    <!-- Import Materialize CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
      rel="stylesheet"
    />
    <!-- Import Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      .highlight {
        background-color: #ffff99; /* light yellow highlight */
      }
      .hold-text {
        color: red;
      }
      .out-btn {
        background-color: #f9a825; /* amber/dark yellow */
        color: white;
      }
      .out-btn.disabled {
        background-color: #9e9e9e !important; /* grey when disabled */
        color: #ffffff !important;
        pointer-events: none;
        opacity: 0.6;
      }
      .back-btn {
        background-color: #43a047; /* green */
        color: white;
      }
      .back-btn.disabled {
        background-color: #9e9e9e !important; /* grey when disabled */
        color: #ffffff !important;
        pointer-events: none;
        opacity: 0.6;
      }
      .table-container {
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div class="container" x-data="appData()" x-init="init()">
      <h5 x-text="dateString"></h5>
      <h6 x-text="'Period: ' + periodString"></h6>
      
      <!-- Auto-detected teacher info -->
      <div class="row" x-show="detectedTeacher">
        <div class="col s12">
          <div class="card-panel teal lighten-4" style="padding: 10px;">
            <span class="black-text">
              <i class="material-icons tiny" style="vertical-align: text-bottom;">person</i>
              Auto-detected teacher: <strong x-text="detectedTeacher"></strong>
              <small x-show="userEmail">(logged in as: <span x-text="userEmail"></span>)</small>
            </span>
          </div>
        </div>
      </div>
      




      <!-- Test buttons for debugging -->
      <div class="row" style="margin-bottom: 10px;">
        <div class="col s12">
        <!-- Test buttons removed - app is now working -->
        </div>
      </div>

      <!-- Main table -->
      <div class="table-container">
        <table class="striped">
          <thead>
            <tr>
              <th>Student Name</th>
              <th>Gender</th>
              <th>Teacher</th>
              <th>Request</th>
              <th>Out Time</th>
              <th>Back</th>
              <th>Back Time</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="stu in students" :key="stu.name">
              <tr :class="{ highlight: isNextInQueue(stu) }">
                <td x-text="stu.name"></td>
                <td>
                  <select x-model="stu.gender" @change="onGenderChange(stu)" class="browser-default">
                    <option value=""></option>
                    <option value="G">G</option>
                    <option value="B">B</option>
                  </select>
                </td>
                <td>
                  <select x-model="stu.teacher" @change="onTeacherChange(stu)" class="browser-default">
                    <template x-for="t in teachers" :key="t">
                      <option x-text="t" :value="t"></option>
                    </template>
                  </select>
                </td>
                <td>
                  <button
                    class="btn out-btn"
                    :class="{ 'disabled': stu.outTime || stu.holdNotice }"
                    @click="markOut(stu)"
                    :title="'Out disabled: ' + (stu.outTime || stu.holdNotice ? 'true' : 'false') + ' | outTime: ' + stu.outTime + ' | holdNotice: ' + stu.holdNotice"
                  >
                    Out
                  </button>
                </td>
                <td>
                  <span x-text="stu.outTime || stu.holdNotice"></span>
                </td>
                <td>
                  <button
                    class="btn back-btn"
                    :class="{ 'disabled': !stu.outTime || stu.backTime }"
                    @click="markBack(stu)"
                    :title="'Back disabled: ' + (!stu.outTime || stu.backTime ? 'true' : 'false') + ' | outTime: ' + stu.outTime + ' | backTime: ' + stu.backTime"
                  >
                    Back
                  </button>
                </td>
                <td>
                  <span x-text="stu.backTime"></span>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <br />

      <!-- Queue table -->
      <h5>Waiting List</h5>
      <table class="striped">
        <thead>
          <tr>
            <th>Girls</th>
            <th>Boys</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <template x-for="(g, idx) in queue.girls" :key="g">
                <div :class="{ highlight: idx === 0 }" x-text="g"></div>
              </template>
            </td>
            <td>
              <template x-for="(b, idx) in queue.boys" :key="b">
                <div :class="{ highlight: idx === 0 }" x-text="b"></div>
              </template>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Materialize JS (for any components) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
      function appData() {
        return {
          dateString: "",
          periodString: "",
          teachers: [],
          detectedTeacher: "",
          userEmail: "",
          students: [],
          queue: { girls: [], boys: [] },

          init() {
            this.loadUserInfo();
          },

          loadUserInfo() {
            console.log('Loading user information...');
            google.script.run
              .withSuccessHandler((userInfo) => {
                console.log('User info received:', userInfo);
                this.userEmail = userInfo.userEmail;
                this.detectedTeacher = userInfo.detectedTeacher;
                this.teachers = userInfo.teacherList;
                
                // Now load the student data
                this.refreshData();
                // Poll every 30 seconds to keep data in sync:
                setInterval(() => this.refreshData(), 30000);
              })
              .withFailureHandler((error) => {
                console.error('Error loading user info:', error);
                // Use fallback teacher list
                this.teachers = [
                  "Mr. Aguilar", "Mrs. Atoui", "Mrs. Bowery", "Mrs. Cantu", "Mr. Casanova",
                  "Mrs. Coyle", "Mr. De Leon", "Mrs. Farias", "Mr. Franco", "Mr. Garcia",
                  "Mr. Goff", "Mr. Gomez", "Dr. Gonzales", "Mr. Hernandez", "Mrs. Hutton",
                  "Mrs. Idrogo", "Mrs. Jasso", "Mrs. Marquez", "Mr. Ollendieck", "Mr. Paez",
                  "Mr. Ramon", "Mrs. Tellez", "Mr. Trevino", "Mrs. Wine", "Mrs. Yeager",
                  "Other Teacher"
                ];
                this.detectedTeacher = "Other Teacher";
                
                // Load student data even if user info fails
                this.refreshData();
                setInterval(() => this.refreshData(), 30000);
              })
              .api_getCurrentUserInfo();
          },



          // Ultra simple test with hardcoded data
          testUltraSimple() {
            console.log('Testing ultra simple...');
            google.script.run
              .withSuccessHandler((resp) => {
                console.log('Ultra simple response:', resp);
                if (resp && resp.students) {
                  alert(`Ultra Simple SUCCESS!\nStudents: ${resp.students.length}`);
                  this.handleFetch(resp);
                } else {
                  alert(`Ultra Simple FAILED - received: ${JSON.stringify(resp)}`);
                }
              })
              .withFailureHandler((error) => {
                console.error('Ultra simple failed:', error);
                alert(`Ultra simple failed: ${error.message || error}`);
              })
              .api_ultraSimpleTest();
          },

          // Test roster only (no status processing)
          testRosterOnly() {
            console.log('Testing roster only...');
            google.script.run
              .withSuccessHandler((resp) => {
                console.log('Roster only response:', resp);
                if (resp && resp.students) {
                  alert(`Roster Only SUCCESS!\nStudents: ${resp.students.length}\nFirst: ${resp.students[0] ? resp.students[0].name : 'None'}`);
                  this.handleFetch(resp);
                } else {
                  alert(`Roster Only FAILED - received: ${JSON.stringify(resp)}`);
                }
              })
              .withFailureHandler((error) => {
                console.error('Roster only failed:', error);
                alert(`Roster only failed: ${error.message || error}`);
              })
              .api_testRosterOnly();
          },

          // Test minimal bypass version (no status processing at all)
          testMinimalBypass() {
            console.log('Testing MINIMAL bypass version...');
            google.script.run
              .withSuccessHandler((resp) => {
                console.log('Minimal bypass response:', resp);
                if (resp && resp.students) {
                  alert(`MINIMAL BYPASS SUCCESS!\nStudents: ${resp.students.length}\nFirst student: ${resp.students[0] ? resp.students[0].name : 'None'}\nNo status processing!`);
                  // Load this data into the interface
                  this.students = resp.students;
                  this.queue = resp.queue || { girls: [], boys: [] };
                } else {
                  console.error('Minimal bypass returned invalid structure:', resp);
                  alert('Minimal bypass returned invalid data: ' + JSON.stringify(resp));
                }
              })
              .withFailureHandler((error) => {
                console.error('Minimal bypass failed:', error);
                alert(`Minimal bypass failed: ${error.message || error}`);
              })
              .api_minimalBypass();
          },

          // Test the October 16 version
          testOctober16() {
            console.log('Testing October 16 2025 version...');
            google.script.run
              .withSuccessHandler((resp) => {
                console.log('October 16 response:', resp);
                if (resp && resp.students) {
                  alert(`OCTOBER 16 SUCCESS!\nStudents: ${resp.students.length}\nFirst student: ${resp.students[0] ? resp.students[0].name : 'None'}`);
                  // Load this data into the interface
                  this.students = resp.students;
                  this.queue = resp.queue || { girls: [], boys: [] };
                } else {
                  console.error('October 16 returned invalid structure:', resp);
                  alert('October 16 returned invalid data: ' + JSON.stringify(resp));
                }
              })
              .withFailureHandler((error) => {
                console.error('October 16 failed:', error);
                alert(`October 16 failed: ${error.message || error}`);
              })
              .api_october16_2025();
          },

          // Test the new function
          testNewFunction() {
            console.log('Testing FINAL working version...');
            google.script.run
              .withSuccessHandler((resp) => {
                console.log('Final version response:', resp);
                if (resp && resp.students) {
                  alert(`FINAL VERSION SUCCESS!\nStudents: ${resp.students.length}\nFirst student: ${resp.students[0] ? resp.students[0].name : 'None'}`);
                  // Load this data into the interface
                  this.students = resp.students;
                  this.queue = resp.queue || { girls: [], boys: [] };
                } else {
                  console.error('Final version returned invalid structure:', resp);
                  alert('Final version returned invalid data: ' + JSON.stringify(resp));
                }
              })
              .withFailureHandler((error) => {
                console.error('Final version failed:', error);
                alert(`Final version failed: ${error.message || error}`);
              })
              .api_finalWorkingVersion();
          },

          refreshData() {
            console.log('refreshData() called');
            
            try {
              console.log('Calling api_minimalBypass...');
              google.script.run
                .withSuccessHandler((result) => {
                  console.log('Response received:', result);
                  
                  if (result && result.students) {
                    console.log('Processing', result.students.length, 'students');
                    this.students = result.students;
                    this.queue = result.queue || { girls: [], boys: [] };
                  } else {
                    console.error('Invalid response structure:', result);
                    alert('Invalid data received from server');
                  }
                })
                .withFailureHandler((error) => {
                  console.error('Error in refreshData:', error);
                  alert('Failed to load student data: ' + error.message);
                })
                .api_minimalBypass();
                
            } catch (error) {
              console.error('Error in refreshData:', error);
              alert('Failed to load student data: ' + error.message);
            }
          },

          handleFetch(resp) {
            // Check if response is valid
            if (!resp) {
              console.error('Received null response from fetchData');
              alert('Error: No data received from server. Please refresh the page.');
              return;
            }
            
            if (!resp.students || !Array.isArray(resp.students)) {
              console.error('Invalid response structure:', resp);
              alert('Error: Invalid data structure received from server. Please refresh the page.');
              return;
            }
            
            // resp has { students, queue }
            console.log('Processing students:', resp.students);
            this.students = resp.students.map((s) => {
              const processedStudent = {
                name: s.name,
                gender: s.gender || "",
                teacher: s.teacher || this.detectedTeacher || this.teachers[0] || "Other Teacher",
                outTime: s.outTime ? this.formatDate(s.outTime) : "",
                backTime: s.backTime ? this.formatDate(s.backTime) : "",
                holdNotice: s.holdNotice || ""
              };
              
              // Debug first few students
              if (resp.students.indexOf(s) < 3) {
                console.log(`Student ${s.name}:`, s);
                console.log(`Processed ${s.name}:`, processedStudent);
                console.log(`${s.name} detailed values:`, {
                  'outTime': `"${processedStudent.outTime}"` + ` (length: ${processedStudent.outTime.length})`,
                  'holdNotice': `"${processedStudent.holdNotice}"` + ` (length: ${processedStudent.holdNotice.length})`,
                  'backTime': `"${processedStudent.backTime}"` + ` (length: ${processedStudent.backTime.length})`,
                  'outTime type': typeof processedStudent.outTime,
                  'holdNotice type': typeof processedStudent.holdNotice,
                  'outTime truthy': !!processedStudent.outTime,
                  'holdNotice truthy': !!processedStudent.holdNotice,
                  'outButtonDisabled': !!(processedStudent.outTime || processedStudent.holdNotice),
                  'backButtonDisabled': !(processedStudent.outTime && !processedStudent.backTime)
                });
              }
              
              return processedStudent;
            });
            this.queue = resp.queue;
            console.log('Final students array:', this.students);
            // Also set dateString and periodString
            // For now, you can get them from resp or compute them
            const now = new Date();
            this.dateString = now.toLocaleDateString();
            this.periodString = "1st Period (Emergency only)"; // you can override
          },

          formatDate(dt) {
            if (!dt) return "";
            // Check if it's already a string that's not a valid date
            if (typeof dt === 'string' && isNaN(Date.parse(dt))) {
              return dt; // Return as-is if it's not a valid date string
            }
            const d = new Date(dt);
            if (isNaN(d.getTime())) {
              return dt; // Return original value if invalid date
            }
            return d.toLocaleTimeString();
          },

          isNextInQueue(stu) {
            const q = this.queue[stu.gender === "G" ? "girls" : "boys"];
            return q.length > 0 && q[0] === stu.name;
          },

          onGenderChange(stu) {
            // Update gender on the server
            console.log('Gender changed for', stu.name, 'to', stu.gender);
          },
          onTeacherChange(stu) {
            // Update teacher on the server
            console.log('Teacher changed for', stu.name, 'to', stu.teacher);
          },



          markOut(stu) {
            console.log('markOut button clicked for:', stu.name);
            console.log('Full student object:', stu);
            console.log('Gender value:', `"${stu.gender}"`, 'Type:', typeof stu.gender, 'Length:', stu.gender ? stu.gender.length : 'N/A');
            console.log('Teacher value:', `"${stu.teacher}"`, 'Type:', typeof stu.teacher, 'Length:', stu.teacher ? stu.teacher.length : 'N/A');
            
            // Validate that gender is selected
            if (!stu.gender || stu.gender.trim() === "") {
              console.log('Gender validation failed - showing alert');
              alert('Please select G or B (Gender) before marking the student out.');
              return;
            }
            
            // Validate that teacher is selected
            if (!stu.teacher || stu.teacher.trim() === "") {
              console.log('Teacher validation failed - showing alert');
              alert('Please select a teacher before marking the student out.');
              return;
            }
            
            console.log('Validations passed. Calling api_updateStatus with:', {
              studentName: stu.name,
              action: "out", 
              teacherName: stu.teacher,
              gender: stu.gender
            });
            
            google.script.run
              .withSuccessHandler((resp) => {
                console.log('Mark out successful:', resp);
                this.handleFetch(resp);
              })
              .withFailureHandler((error) => {
                console.error('Error marking out:', error);
                console.error('Error details:', error.message, error.stack);
                alert(`Error marking student out: ${error.message || error}\n\nCheck console for details.`);
              })
              .api_updateStatus(stu.name, "out", stu.teacher, stu.gender);
          },

          markBack(stu) {
            console.log('markBack button clicked for:', stu.name);
            console.log('Student data:', stu);
            console.log('Calling api_updateStatus with:', {
              name: stu.name,
              action: "back", 
              teacher: stu.teacher,
              gender: stu.gender
            });
            
            google.script.run
              .withSuccessHandler((resp) => {
                console.log('Mark back successful:', resp);
                this.handleFetch(resp);
              })
              .withFailureHandler((error) => {
                console.error('Error marking back:', error);
                alert('Error marking student back. Please try again.');
              })
              .api_updateStatus(stu.name, "back", stu.teacher, stu.gender);
          }
        };
      }
    </script>
    
    <!-- Alpine.js - loaded after appData function is defined -->
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </body>
</html>
