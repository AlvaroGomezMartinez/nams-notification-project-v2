<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>NAMS Restroom Sign-Out</title>
    <!-- Import Materialize CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
      rel="stylesheet"
    />
    <!-- Import Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      .highlight {
        background-color: #ffff99; /* light yellow highlight */
      }
      .hold-text {
        color: red;
      }
      .out-btn {
        background-color: #f9a825; /* amber/dark yellow */
        color: white;
      }
      .out-btn.disabled {
        background-color: #9e9e9e !important; /* grey when disabled */
        color: #ffffff !important;
        pointer-events: none;
        opacity: 0.6;
      }
      .back-btn {
        background-color: #43a047; /* green */
        color: white;
      }
      .back-btn.disabled {
        background-color: #9e9e9e !important; /* grey when disabled */
        color: #ffffff !important;
        pointer-events: none;
        opacity: 0.6;
      }
      .table-container {
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div class="container" x-data="appData()" x-init="init()">
      <h5 x-text="dateString"></h5>
      <h6 x-text="'Period: ' + periodString"></h6>
      
      <!-- Auto-detected teacher info -->
      <div class="row" x-show="detectedTeacher">
        <div class="col s12">
          <div class="card-panel teal lighten-4" style="padding: 10px;">
            <span class="black-text">
              <i class="material-icons tiny" style="vertical-align: text-bottom;">person</i>
              Auto-detected teacher: <strong x-text="detectedTeacher"></strong>
              <small x-show="userEmail">(logged in as: <span x-text="userEmail"></span>)</small>
            </span>
          </div>
        </div>
      </div>
      


      <!-- Main table -->
      <div class="table-container">
        <table class="striped">
          <thead>
            <tr>
              <th>Student Name</th>
              <th>G / B</th>
              <th>Teacher</th>
              <th>Out</th>
              <th>Out Time</th>
              <th>Back</th>
              <th>Back Time</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="stu in students" :key="stu.name">
              <tr :class="{ highlight: isNextInQueue(stu) }">
                <td x-text="stu.name"></td>
                <td>
                  <select x-model="stu.gender" @change="onGenderChange(stu)" class="browser-default">
                    <option value="G">G</option>
                    <option value="B">B</option>
                  </select>
                </td>
                <td>
                  <select x-model="stu.teacher" @change="onTeacherChange(stu)" class="browser-default">
                    <template x-for="t in teachers" :key="t">
                      <option x-text="t" :value="t"></option>
                    </template>
                  </select>
                </td>
                <td>
                  <button
                    class="btn out-btn"
                    :class="{ 'disabled': stu.outTime || stu.holdNotice }"
                    @click="markOut(stu)"
                    :title="'Out disabled: ' + (stu.outTime || stu.holdNotice ? 'true' : 'false') + ' | outTime: ' + stu.outTime + ' | holdNotice: ' + stu.holdNotice"
                  >
                    Out
                  </button>
                </td>
                <td>
                  <span x-text="stu.outTime || stu.holdNotice"></span>
                </td>
                <td>
                  <button
                    class="btn back-btn"
                    :class="{ 'disabled': !stu.outTime || stu.backTime }"
                    @click="markBack(stu)"
                    :title="'Back disabled: ' + (!stu.outTime || stu.backTime ? 'true' : 'false') + ' | outTime: ' + stu.outTime + ' | backTime: ' + stu.backTime"
                  >
                    Back
                  </button>
                </td>
                <td>
                  <span x-text="stu.backTime"></span>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <br />

      <!-- Queue table -->
      <h5>Waiting List</h5>
      <table class="striped">
        <thead>
          <tr>
            <th>Girls</th>
            <th>Boys</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <template x-for="(g, idx) in queue.girls" :key="g">
                <div :class="{ highlight: idx === 0 }" x-text="g"></div>
              </template>
            </td>
            <td>
              <template x-for="(b, idx) in queue.boys" :key="b">
                <div :class="{ highlight: idx === 0 }" x-text="b"></div>
              </template>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Materialize JS (for any components) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
      function appData() {
        return {
          dateString: "",
          periodString: "",
          teachers: [],
          detectedTeacher: "",
          userEmail: "",
          students: [],
          queue: { girls: [], boys: [] },

          init() {
            this.loadUserInfo();
          },

          loadUserInfo() {
            console.log('Loading user information...');
            google.script.run
              .withSuccessHandler((userInfo) => {
                console.log('User info received:', userInfo);
                this.userEmail = userInfo.userEmail;
                this.detectedTeacher = userInfo.detectedTeacher;
                this.teachers = userInfo.teacherList;
                
                // Now load the student data
                this.refreshData();
                // Poll every 30 seconds to keep data in sync:
                setInterval(() => this.refreshData(), 30000);
              })
              .withFailureHandler((error) => {
                console.error('Error loading user info:', error);
                // Use fallback teacher list
                this.teachers = [
                  "Mr. Aguilar", "Mrs. Atoui", "Mrs. Bowery", "Mrs. Cantu", "Mr. Casanova",
                  "Mrs. Coyle", "Mr. De Leon", "Mrs. Farias", "Mr. Franco", "Mr. Garcia",
                  "Mr. Goff", "Mr. Gomez", "Dr. Gonzales", "Mr. Hernandez", "Mrs. Hutton",
                  "Mrs. Idrogo", "Mrs. Jasso", "Mrs. Marquez", "Mr. Ollendieck", "Mr. Paez",
                  "Mr. Ramon", "Mrs. Tellez", "Mr. Trevino", "Mrs. Wine", "Mrs. Yeager",
                  "Other Teacher"
                ];
                this.detectedTeacher = "Other Teacher";
                
                // Load student data even if user info fails
                this.refreshData();
                setInterval(() => this.refreshData(), 30000);
              })
              .api_getCurrentUserInfo();
          },

          refreshData() {
            console.log('Fetching data from Google Apps Script...');
            google.script.run
              .withSuccessHandler((resp) => {
                console.log('Received data:', resp);
                if (resp === null || resp === undefined) {
                  console.error('Received null/undefined response from api_fetchData');
                  alert('Error: Server returned empty response. This might be due to a server-side error. Check the Apps Script logs.');
                  return;
                }
                
                // Check if response indicates an error
                if (resp.success === false || resp.error) {
                  console.error('Server returned error response:', resp);
                  alert(`Server Error: ${resp.error}\n\nCheck console for details.`);
                  return;
                }
                
                this.handleFetch(resp);
              })
              .withFailureHandler((error) => {
                console.error('Error fetching data:', error);
                // Show user-friendly error message
                alert('Error loading student data. Please refresh the page or contact support.\n\nError details: ' + (error.message || error));
              })
              .api_fetchData();
          },

          handleFetch(resp) {
            // Check if response is valid
            if (!resp) {
              console.error('Received null response from fetchData');
              alert('Error: No data received from server. Please refresh the page.');
              return;
            }
            
            if (!resp.students || !Array.isArray(resp.students)) {
              console.error('Invalid response structure:', resp);
              alert('Error: Invalid data structure received from server. Please refresh the page.');
              return;
            }
            
            // resp has { students, queue }
            console.log('Processing students:', resp.students);
            this.students = resp.students.map((s) => {
              const processedStudent = {
                name: s.name,
                gender: s.gender || "G",
                teacher: s.teacher || this.detectedTeacher || this.teachers[0] || "Other Teacher",
                outTime: s.outTime ? this.formatDate(s.outTime) : "",
                backTime: s.backTime ? this.formatDate(s.backTime) : "",
                holdNotice: s.holdNotice || ""
              };
              
              // Debug first few students
              if (resp.students.indexOf(s) < 3) {
                console.log(`Student ${s.name}:`, s);
                console.log(`Processed ${s.name}:`, processedStudent);
                console.log(`${s.name} detailed values:`, {
                  'outTime': `"${processedStudent.outTime}"` + ` (length: ${processedStudent.outTime.length})`,
                  'holdNotice': `"${processedStudent.holdNotice}"` + ` (length: ${processedStudent.holdNotice.length})`,
                  'backTime': `"${processedStudent.backTime}"` + ` (length: ${processedStudent.backTime.length})`,
                  'outTime type': typeof processedStudent.outTime,
                  'holdNotice type': typeof processedStudent.holdNotice,
                  'outTime truthy': !!processedStudent.outTime,
                  'holdNotice truthy': !!processedStudent.holdNotice,
                  'outButtonDisabled': !!(processedStudent.outTime || processedStudent.holdNotice),
                  'backButtonDisabled': !(processedStudent.outTime && !processedStudent.backTime)
                });
              }
              
              return processedStudent;
            });
            this.queue = resp.queue;
            console.log('Final students array:', this.students);
            // Also set dateString and periodString
            // For now, you can get them from resp or compute them
            const now = new Date();
            this.dateString = now.toLocaleDateString();
            this.periodString = "1st Period (Emergency only)"; // you can override
          },

          formatDate(dt) {
            if (!dt) return "";
            // Check if it's already a string that's not a valid date
            if (typeof dt === 'string' && isNaN(Date.parse(dt))) {
              return dt; // Return as-is if it's not a valid date string
            }
            const d = new Date(dt);
            if (isNaN(d.getTime())) {
              return dt; // Return original value if invalid date
            }
            return d.toLocaleTimeString();
          },

          isNextInQueue(stu) {
            const q = this.queue[stu.gender === "G" ? "girls" : "boys"];
            return q.length > 0 && q[0] === stu.name;
          },

          onGenderChange(stu) {
            // Update gender on the server
            console.log('Gender changed for', stu.name, 'to', stu.gender);
          },
          onTeacherChange(stu) {
            // Update teacher on the server
            console.log('Teacher changed for', stu.name, 'to', stu.teacher);
          },

          // Debug function to check spreadsheet structure
          debugSheet() {
            console.log('Debugging sheet structure...');
            google.script.run
              .withSuccessHandler((resp) => {
                console.log('Sheet debug info:', resp);
                alert('Sheet info logged to console. Check developer tools.');
              })
              .withFailureHandler((error) => {
                console.error('Error debugging sheet:', error);
              })
              .api_debugSheet();
          },

          // Debug function to check Log sheet entries
          debugLogSheet() {
            console.log('Debugging Log sheet entries...');
            google.script.run
              .withSuccessHandler((resp) => {
                console.log('Log sheet debug info:', resp);
                alert(`Found ${resp.todaysEntries ? resp.todaysEntries.length : 0} entries for today. Check console for details.`);
              })
              .withFailureHandler((error) => {
                console.error('Error debugging log sheet:', error);
              })
              .api_debugLogSheet();
          },

          // Debug function to test user detection
          testUserDetection() {
            console.log('Testing user detection...');
            google.script.run
              .withSuccessHandler((userInfo) => {
                console.log('User detection test result:', userInfo);
                alert(`User: ${userInfo.userEmail || 'Not detected'}\nTeacher: ${userInfo.detectedTeacher}\nCheck console for full details.`);
              })
              .withFailureHandler((error) => {
                console.error('Error testing user detection:', error);
                alert('Error testing user detection. Check console for details.');
              })
              .api_getCurrentUserInfo();
          },

          // Debug function to test fetchData
          testFetchData() {
            console.log('Testing fetchData...');
            google.script.run
              .withSuccessHandler((result) => {
                console.log('FetchData test result:', result);
                if (result.success) {
                  alert(`FetchData SUCCESS:\nStudents: ${result.result && result.result.students ? result.result.students.length : 0}\nCheck console for full details.`);
                } else {
                  alert(`FetchData FAILED:\n${result.error}\nCheck console for stack trace.`);
                }
              })
              .withFailureHandler((error) => {
                console.error('Error testing fetchData:', error);
                alert('Error testing fetchData. Check console for details.\n\n' + (error.message || error));
              })
              .api_testFetchData();
          },

          // Debug function to list all sheets
          listSheets() {
            console.log('Listing all sheets...');
            google.script.run
              .withSuccessHandler((result) => {
                console.log('Sheet list result:', result);
                if (result.success) {
                  const sheetNames = result.sheets.map(s => s.name).join(', ');
                  alert(`Available Sheets (${result.sheets.length}):\n${sheetNames}\n\nLooking for: ${result.todayString}\nCheck console for full details.`);
                } else {
                  alert(`List Sheets FAILED:\n${result.error}`);
                }
              })
              .withFailureHandler((error) => {
                console.error('Error listing sheets:', error);
                alert('Error listing sheets. Check console for details.');
              })
              .api_listSheets();
          },

          // Debug function to inspect a specific sheet
          inspectSheet() {
            if (!this.inspectSheetName.trim()) {
              alert('Please enter a sheet name to inspect');
              return;
            }
            
            console.log('Inspecting sheet:', this.inspectSheetName);
            google.script.run
              .withSuccessHandler((result) => {
                console.log('Sheet inspection result:', result);
                if (result.success) {
                  alert(`Sheet: ${result.sheetName}\nRows: ${result.totalRows}\nColumns: ${result.totalColumns}\nCheck console for detailed content.`);
                } else {
                  alert(`Inspect Sheet FAILED:\n${result.error}`);
                }
              })
              .withFailureHandler((error) => {
                console.error('Error inspecting sheet:', error);
                alert('Error inspecting sheet. Check console for details.');
              })
              .api_inspectSheet(this.inspectSheetName);
          },

          // Debug function to test basic spreadsheet access
          testBasicAccess() {
            console.log('Testing basic spreadsheet access...');
            google.script.run
              .withSuccessHandler((result) => {
                console.log('Basic access test result:', result);
                if (result.success) {
                  alert(`Basic Access SUCCESS!\nSheets: ${result.sheetCount}\nSelected: ${result.selectedSheet}\nDimensions: ${result.sheetDimensions.rows}x${result.sheetDimensions.columns}\nCheck console for details.`);
                } else {
                  alert(`Basic Access FAILED:\n${result.error}`);
                }
              })
              .withFailureHandler((error) => {
                console.error('Error testing basic access:', error);
                alert('Error testing basic access. Check console for details.');
              })
              .api_testBasicAccess();
          },

          // Debug function to test student roster reading
          testStudentRoster() {
            console.log('Testing student roster reading...');
            google.script.run
              .withSuccessHandler((result) => {
                console.log('Student roster test result:', result);
                if (result.success) {
                  alert(`Student Roster SUCCESS!\nSheet: ${result.sheetName}\nStudents: ${result.studentCount}\nCheck console for student list.`);
                } else {
                  alert(`Student Roster FAILED:\n${result.error}`);
                }
              })
              .withFailureHandler((error) => {
                console.error('Error testing student roster:', error);
                alert('Error testing student roster. Check console for details.');
              })
              .api_testStudentRoster();
          },

          // Debug function to test restroom status reading
          testRestroomStatus() {
            console.log('Testing restroom status reading...');
            google.script.run
              .withSuccessHandler((result) => {
                console.log('Restroom status test result:', result);
                if (result.success) {
                  alert(`Restroom Status SUCCESS!\nStudents with status: ${result.statusCount}\nCheck console for details.`);
                } else {
                  alert(`Restroom Status FAILED:\n${result.error}`);
                }
              })
              .withFailureHandler((error) => {
                console.error('Error testing restroom status:', error);
                alert('Error testing restroom status. Check console for details.');
              })
              .api_testRestroomStatus();
          },

          markOut(stu) {
            console.log('markOut button clicked for:', stu.name);
            console.log('Student data:', stu);
            console.log('Calling api_updateStatus with:', {
              name: stu.name,
              action: "out", 
              teacher: stu.teacher,
              gender: stu.gender
            });
            
            google.script.run
              .withSuccessHandler((resp) => {
                console.log('Mark out successful:', resp);
                this.handleFetch(resp);
              })
              .withFailureHandler((error) => {
                console.error('Error marking out:', error);
                alert('Error marking student out. Please try again.');
              })
              .api_updateStatus(stu.name, "out", stu.teacher, stu.gender);
          },

          markBack(stu) {
            console.log('markBack button clicked for:', stu.name);
            console.log('Student data:', stu);
            console.log('Calling api_updateStatus with:', {
              name: stu.name,
              action: "back", 
              teacher: stu.teacher,
              gender: stu.gender
            });
            
            google.script.run
              .withSuccessHandler((resp) => {
                console.log('Mark back successful:', resp);
                this.handleFetch(resp);
              })
              .withFailureHandler((error) => {
                console.error('Error marking back:', error);
                alert('Error marking student back. Please try again.');
              })
              .api_updateStatus(stu.name, "back", stu.teacher, stu.gender);
          }
        };
      }
    </script>
    
    <!-- Alpine.js - loaded after appData function is defined -->
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </body>
</html>
